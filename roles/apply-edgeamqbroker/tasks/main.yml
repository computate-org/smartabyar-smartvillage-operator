---

# Install AMQ Broker
- name: "Install {{ site_name }} AMQ Broker on OpenShift"
  k8s:
    state: "{{ 'present' if values.amq_broker.create else 'absent' }}"
    api_version: broker.amq.io/v1beta1
    kind: ActiveMQArtemis
    name: fiware-broker
    namespace: "{{ ansible_operator_meta.namespace }}"
    definition: "{{ lookup('template', 'activemqartemis.yaml') }}"
  when: values.amq_broker.create
- name: "Install {{ site_name }} AMQ Broker Address on OpenShift"
  k8s:
    state: "{{ 'present' if values.amq_broker.create else 'absent' }}"
    api_version: broker.amq.io/v1beta1
    kind: ActiveMQArtemisAddress
    name: fiware-address
    namespace: "{{ ansible_operator_meta.namespace }}"
    definition: "{{ lookup('template', 'activemqartemisaddress.yaml') }}"
  when: values.amq_broker.create

- name: "Verify MQTT"
  wait_for:
    host: "{{ values.amq_broker.mqtt_service_name + '.' + ansible_operator_meta.namespace + '.svc' }}"
    port: "{{ values.amq_broker.mqtt_port }}"
    state: started
    delay: 0
    timeout: 5
  register: verify_mqtt
  ignore_errors: yes
  when: verify_connections and values.amq_broker.create
- name: "Verify MQTT is running"
  fail:
    msg: |-
      The MQTT service was unavailable. Have you run the prerequisite Ansible Playbook? https://github.com/computate-org/smartvillage-operator/blob/main/prepare-smartabyarsmartvillage.yaml
  when: verify_connections and values.amq_broker.create and verify_mqtt.failed
