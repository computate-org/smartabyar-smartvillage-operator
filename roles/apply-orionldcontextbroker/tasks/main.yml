---
- name: Clone marinera chart repo
  ansible.builtin.git:
    repo: https://github.com/FIWARE-Ops/marinera.git
    dest: /tmp/marinera

- name: Add bitnami chart repo
  kubernetes.core.helm_repository:
    name: bitnami
    repo_url: https://charts.bitnami.com/bitnami

- name: Add FIWARE Marinera mongodb helm chart
  kubernetes.core.helm:
    name: mongodb-orion
    chart_ref: bitnami/mongodb
    chart_version: 12.1.31
    set_values:
      - value: nameOverride=mongodb-orion
      - value: fullnameOverride=mongodb-orion
      - value: architecture=standalone
      - value: podSecurityContext.enabled=false
      - value: containerSecurityContext.enabled=false
      - value: resources.limits.memory=3Gi
      - value: resources.requests.cpu=50m
      - value: resources.requests.memory=300Mi
      - value: persistence.enabled=true
      - value: persistence.size=8Gi
      - value: readinessProbe.timeoutSeconds=60
      - value: arbiter.podSecurityContext.enabled=false
      - value: arbiter.containerSecurityContext.enabled=false
      - value: |-
          "arbiter.podLabels.marinera/platform=fiware"
      - value: |-
          "arbiter.podLabels.marinera/component=core"
      - value: |-
          "arbiter.podLabels.marinera/subcomponent=persistence"
      - value: |-
          "arbiter.podLabels.marinera/product=mongodb"
      - value: arbiter.resources.limits.memory=1.5Gi
      - value: arbiter.resources.requests.cpu=50m
      - value: arbiter.resources.requests.memory=300Mi
      - value: arbiter.readinessProbe.timeoutSeconds=60
      - value: systemLogVerbosity=1
      - value: |-
          "podLabels.marinera/platform=fiware"
      - value: |-
          "podLabels.marinera/component=core"
      - value: |-
          "podLabels.marinera/subcomponent=persistence"
      - value: |-
          "podLabels.marinera/product=mongodb"
      - value: metrics.enabled=true
      - value: serviceMonitor.enabled=true
      - value: resources.limits.memory=1Gi
      - value: resources.requests.cpu=50m
      - value: resources.requests.memory=50Mi
      - value: readinessProbe.timeoutSeconds=60
    release_namespace: "{{ ansible_operator_meta.namespace }}"
    release_state: present

#- name: Add FIWARE Marinera orion-ld helm chart
#  kubernetes.core.helm:
#    name: orion-ld
#    chart_ref: /tmp/marinera/fiware-platform
#    set_values:
#      - value: orion-ld.broker.db.hosts=["mongodb-orion"]
#      - value: orion-ld.deployment.replicaCount=1
#      - value: orion-ld.route.enabled=true
#    release_namespace: ansible_operator_meta.namespace
#    release_state: present
